<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
                  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<article>
  <articleinfo>
    <title>Scale</title>
  </articleinfo>
<para>
  In this lesson you'll learn how to scale Sync Gateway and Couchbase
  Server in real-time with zero downtime.
</para>
<sect1 id="requirements">
  <title>Requirements</title>
  <para>
    Three instances with the following:
  </para>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Centos 7
      </para>
    </listitem>
    <listitem>
      <para>
        RAM &gt;= 2GB
      </para>
    </listitem>
  </itemizedlist>
</sect1>
<sect1 id="getting-started">
  <title>Getting Started</title>
  <para>
    This lesson contains some scripts to automatically deploy and
    configure Sync Gateway with Couchbase Server. Download those scripts
    on each VM using wget.
  </para>
  <programlisting language="bash">
ssh vagrant@192.168.34.11
wget https://cl.ly/1q300A3v3R1D/deploy.zip
sudo yum install -y unzip
unzip deploy.zip
</programlisting>
  <para>
    Throughout this lesson, you will use different scripts located in
    the <emphasis role="strong">deploy</emphasis> folder.
  </para>
</sect1>
<sect1 id="architecture">
  <title>Architecture</title>
  <para>
    In this lesson you will deploy a 3rd Sync Gateway node behind the
    reverse proxy.
  </para>
  <figure>
    <mediaobject>
      <imageobject>
        <imagedata fileref="img/image80.png" />
      </imageobject>
      <textobject><phrase></phrase></textobject>
    </mediaobject>
  </figure>
</sect1>
<sect1 id="scaling-sync-gateway">
  <title>Scaling Sync Gateway</title>
  <para>
    Similarly to previous lessons you will first deploy Sync Gateway
    with the configuration file passing the IP of the VM running
    Couchbase Server.
  </para>
  <para>
    There will be 3 Sync Gateway nodes but the reverse proxy is
    forwarding the load to only 2 of them. To balance the traffic across
    all 3 you must update the NGINX config file with the IP of VM5.
  </para>
  <sect2 id="try-it-out">
    <title>Try it out</title>
    <orderedlist numeration="arabic">
      <listitem>
        <para>
          Log on VM5 (sync-gateway).
        </para>
      </listitem>
      <listitem>
        <para>
          <literal>cd deploy</literal>
        </para>
      </listitem>
      <listitem>
        <para>
          Run the Sync Gateway install latest script passing the IP of
          VM1 where Couchbase Server is running.
        </para>
        <programlisting language="bash">
sudo ./install_latest_sync_gateway.sh VM1
</programlisting>
      </listitem>
      <listitem>
        <para>
          Log on VM4 (nginx).
        </para>
      </listitem>
      <listitem>
        <para>
          Run the NGINX install script passing the IP of VM2, VM3 and
          VM4 where the Sync Gateway instances are running.
        </para>
        <programlisting language="bash">
sudo ./configure_nginx.sh VM2 VM3 VM5
</programlisting>
      </listitem>
      <listitem>
        <para>
          Send a curl request to http://localhost:8000. This will return
          information about the running sync_gateway behind the reverse
          proxy.
        </para>
        <programlisting language="bash">
curl localhost:8000
</programlisting>
        <figure>
          <mediaobject>
            <imageobject>
              <imagedata fileref="https://cl.ly/392N2E2K0J0T/image76.gif" />
            </imageobject>
            <textobject><phrase></phrase></textobject>
          </mediaobject>
        </figure>
      </listitem>
    </orderedlist>
    <para>
      <block class="all" />
    </para>
  </sect2>
</sect1>
<sect1 id="conclusion">
  <title>Conclusion</title>
  <para>
    Well done! You've completed this lesson on scaling. Feel free to
    share your feedback, findings or ask any questions on the forums.
  </para>
</sect1>
</article>
