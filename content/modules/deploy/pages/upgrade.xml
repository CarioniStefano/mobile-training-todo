<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
                  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<article>
  <articleinfo>
    <title>Upgrade</title>
  </articleinfo>
<para>
  In this lesson you'll learn how to install upgrades for Sync Gateway
  with zero downtime.
</para>
<sect1 id="requirements">
  <title>Requirements</title>
  <para>
    Three instances with the following:
  </para>
  <itemizedlist spacing="compact">
    <listitem>
      <para>
        Centos 7
      </para>
    </listitem>
    <listitem>
      <para>
        RAM &gt;= 2GB
      </para>
    </listitem>
  </itemizedlist>
</sect1>
<sect1 id="getting-started">
  <title>Getting Started</title>
  <para>
    This lesson contains some scripts to automatically deploy and
    configure Sync Gateway with Couchbase Server. Download those scripts
    on each VM using wget.
  </para>
  <programlisting language="bash">
ssh vagrant@192.168.34.11
wget https://cl.ly/1q300A3v3R1D/deploy.zip
sudo yum install -y unzip
unzip deploy.zip
</programlisting>
  <para>
    Throughout this lesson, you will use different scripts located in
    the <emphasis role="strong">deploy</emphasis> folder.
  </para>
</sect1>
<sect1 id="architecture">
  <title>Architecture</title>
  <para>
    To follow this lesson you must first have completed the Install
    lesson and have 2 Sync Gateway nodes up and running. You have
    deployed Sync Gateway 1.3 and in this lesson you will deploy Sync
    Gateway 1.3.1 as a rolling upgrade.
  </para>
  <para>
    A rolling upgrade means that the nodes are upgraded one at a time.
    While a node is being upgraded it's taken offline by rebalancing the
    traffic to other nodes. The diagram below shows this process.
  </para>
</sect1>
<sect1 id="upgrading-vm2">
  <title>Upgrading VM2</title>
  <para>
    First you will need to redirect the traffic to only one Sync Gateway
    node (VM3). Once the traffic is redirected you will upgrade Sync
    Gateway on VM2.
  </para>
  <figure>
    <mediaobject>
      <imageobject>
        <imagedata fileref="img/image79.png" />
      </imageobject>
      <textobject><phrase></phrase></textobject>
    </mediaobject>
  </figure>
  <sect2 id="try-it-out">
    <title>Try it out</title>
    <orderedlist numeration="arabic">
      <listitem>
        <para>
          Log on VM4 (nginx).
        </para>
      </listitem>
      <listitem>
        <para>
          <literal>cd deploy</literal>
        </para>
      </listitem>
      <listitem>
        <para>
          Run the NGINX script passing only the IP of VM3.
        </para>
        <programlisting language="bash">
sudo ./configure_nginx.sh VM3
</programlisting>
      </listitem>
      <listitem>
        <para>
          Log into VM2 (sync-gateway)
        </para>
      </listitem>
      <listitem>
        <para>
          Run the Sync Gateway upgrade script on VM2.
        </para>
        <programlisting language="bash">
sudo ./upgrade_sync_gateway.sh
</programlisting>
      </listitem>
      <listitem>
        <para>
          Change back to VM4
        </para>
      </listitem>
      <listitem>
        <para>
          Run the NGINX script again this time passing the IP of VM2 and
          VM3.
        </para>
        <programlisting language="bash">
sudo ./configure_nginx.sh VM2 VM3
</programlisting>
      </listitem>
      <listitem>
        <para>
          Monitor the NGINX operations in real-time.
        </para>
        <programlisting language="bash">
sudo tail -f /var/log/nginx/access_log
</programlisting>
      </listitem>
      <listitem>
        <para>
          Change back to VM4.
        </para>
      </listitem>
      <listitem>
        <para>
          Send a server request to the NGINX port. The response contains
          the Sync Gateway version. Notice it switches between 1.3.0 and
          1.3.1 because only one node was upgraded.
        </para>
        <programlisting language="bash">
curl 'http://localhost:8000'
</programlisting>
        <figure>
          <mediaobject>
            <imageobject>
              <imagedata fileref="https://cl.ly/3m0g1R0J0w37/image77.gif" />
            </imageobject>
            <textobject><phrase></phrase></textobject>
          </mediaobject>
        </figure>
      </listitem>
    </orderedlist>
  </sect2>
</sect1>
<sect1 id="upgrading-vm3">
  <title>Upgrading VM3</title>
  <para>
    In this section you will perform the same sequence of operations to
    upgrade Sync Gateway on VM3.
  </para>
  <figure>
    <mediaobject>
      <imageobject>
        <imagedata fileref="img/image78.png" />
      </imageobject>
      <textobject><phrase></phrase></textobject>
    </mediaobject>
  </figure>
  <sect2 id="try-it-out-1">
    <title>Try it out</title>
    <orderedlist numeration="arabic">
      <listitem>
        <para>
          Log on VM4 (nginx).
        </para>
      </listitem>
      <listitem>
        <para>
          Run the NGINX script passing only the IP of VM2.
        </para>
        <programlisting language="bash">
sudo ./configure_nginx.sh VM2
</programlisting>
      </listitem>
      <listitem>
        <para>
          Log on VM3 (sync-gateway).
        </para>
      </listitem>
      <listitem>
        <para>
          Run the Sync Gateway upgrade script on VM3.
        </para>
        <programlisting language="bash">
sudo ./upgrade_sync_gateway.sh
</programlisting>
      </listitem>
      <listitem>
        <para>
          Log on VM4 (nginx).
        </para>
      </listitem>
      <listitem>
        <para>
          Run the NGINX script again this time passing the IP of VM2 and
          VM3.
        </para>
        <programlisting language="bash">
sudo ./configure_nginx.sh VM2 VM3
</programlisting>
      </listitem>
      <listitem>
        <para>
          Verify that the Sync Gateway version is now 1.3.1.
        </para>
        <programlisting language="bash">
curl VM4:8000

{
    &quot;couchdb&quot;:&quot;Welcome&quot;,
    &quot;vendor&quot;:{&quot;name&quot;:&quot;Couchbase Sync Gateway&quot;,&quot;version&quot;:1.3},
    &quot;version&quot;:&quot;Couchbase Sync Gateway/1.3.1(16;f18e833)&quot;
}
</programlisting>
      </listitem>
    </orderedlist>
    <para>
      <block class="all" />
    </para>
  </sect2>
</sect1>
<sect1 id="conclusion">
  <title>Conclusion</title>
  <para>
    Well done! You've completed this lesson on upgrading the Sync
    Gateway version. In the next lesson you will learn how to scale Sync
    Gatway by adding additional nodes. Feel free to share your feedback,
    findings or ask any questions on the forums.
  </para>
</sect1>
</article>
